# Guardrails / Change Gate

VibeAnvil's **Guardrails** feature (also known as Change Gate) provides automated risk assessment and approval gates for code changes generated by AI providers.

## Overview

Every change generated by an AI provider is encapsulated in a **Change Capsule** and analyzed by the **Risk Classifier**. Based on the risk level, the change is either auto-applied or presented for approval.

### Risk Levels

| Level | Description | Examples | Action (Normal Mode) |
|-------|-------------|----------|----------------------|
| **A** | **Safe / Cosmetic** | Docs, comments, typos, formatting | ‚úÖ Auto-Apply |
| **B** | **Logic Change** | Refactors, new functions, tests | ‚ö†Ô∏è Require Approval |
| **C** | **High Impact** | Public API, dependencies, security, config | üõë Require Impact Analysis + Approval |

## Configuration

Guardrails are configured in `state.json` (or via CLI in future versions).

```json
{
  "guardrails": {
    "enabled": true,
    "mode": "normal",
    "auto_approve_level_a": true,
    "require_impact_for_c": true
  }
}
```

### Modes

- **off**: Guardrails are disabled. All changes are applied immediately.
- **normal** (default): Level A is auto-approved. Level B/C require approval.
- **strict**: All levels require approval. Level C requires detailed impact analysis.

## Usage

When running `vibeanvil build iterate`, the guardrails are automatically active if enabled.

1. **Analysis**: The tool analyzes the diff generated by the AI.
2. **Presentation**: If approval is needed, you will see a summary of the changes, risk level, and reasons.
3. **Decision**:
   - **Approve (y)**: The change is applied to your workspace.
   - **Deny (n)**: The change is discarded (reverted).

### CI / Automated Environments

For CI/CD pipelines, you can use **File-Based Approval**.
Place a file named `approve.json` in the capsule directory (inside `.vibeanvil/session/<id>/capsules/<id>/`) with the following content:

```json
{
  "capsule_id": "<capsule-id>",
  "approved": true,
  "approved_by": "ci-bot"
}
```

## Audit Logs

All guardrail events are logged to the session audit log:
- `RISK_CLASSIFIED`: Risk level and reasons.
- `DIFF_PRESENTED`: Diff stats.
- `APPROVAL_GRANTED`: Who approved and how.
- `APPROVAL_DENIED`: Reason for denial.
- `CAPSULE_APPLIED`: Files changed.
